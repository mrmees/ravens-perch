{% extends "base.html" %}

{% block title %}Settings - Ravens Perch{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Settings</h1>
</div>

<div class="settings-layout">
    <div class="settings-card">
        <h3>General Settings</h3>

        <form method="POST"
              action="{{ url_for('cameras.update_global_settings') }}"
              hx-post="{{ url_for('cameras.update_global_settings') }}"
              hx-swap="innerHTML"
              hx-target="#settings-status">

            <div class="form-group">
                <label for="moonraker_url">Moonraker URL</label>
                <input type="text"
                       id="moonraker_url"
                       name="moonraker_url"
                       value="{{ settings.get('moonraker_url', 'http://127.0.0.1:7125') }}"
                       placeholder="http://127.0.0.1:7125">
                <p class="form-help">
                    Status:
                    {% if moonraker_available %}
                        <span class="status-text status-ok">Connected</span>
                    {% else %}
                        <span class="status-text status-error">Not connected</span>
                    {% endif %}
                </p>
            </div>

            <div class="form-group">
                <label for="log_level">Log Level</label>
                <select id="log_level" name="log_level">
                    {% for level in ['DEBUG', 'INFO', 'WARNING', 'ERROR'] %}
                        <option value="{{ level }}"
                                {% if settings.get('log_level', 'INFO') == level %}selected{% endif %}>
                            {{ level }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div id="settings-status"></div>

            <button type="submit" class="btn btn-primary">Save Settings</button>
        </form>
    </div>

    <div class="settings-card">
        <h3>Appearance</h3>

        <form method="POST"
              action="{{ url_for('cameras.update_global_settings') }}"
              hx-post="{{ url_for('cameras.update_global_settings') }}"
              hx-swap="innerHTML"
              hx-target="#appearance-status">

            <input type="hidden" id="accent_color" name="accent_color" value="{{ settings.get('accent_color', '#4A9EFF')|upper }}">
            <input type="hidden" id="custom_accent_color" name="custom_accent_color" value="{{ settings.get('custom_accent_color', '#4A9EFF')|upper }}">

            <div class="form-group">
                <label>Accent Color</label>
                <div class="color-options-list">
                    <!-- Custom color option -->
                    <div class="color-option-row" data-color-type="custom">
                        <span class="color-option-label">Custom</span>
                        <input type="color"
                               id="custom_color_picker"
                               value="{{ settings.get('custom_accent_color', '#4A9EFF')|upper }}"
                               class="color-input">
                        <span class="color-value" id="custom-color-value">{{ settings.get('custom_accent_color', '#4A9EFF')|upper }}</span>
                    </div>

                    <!-- Mainsail color option (populated by JS if detected) -->
                    <div class="color-option-row" id="mainsail-option" style="display: none;" data-color-type="mainsail">
                        <span class="color-option-label">Mainsail</span>
                        <span class="color-swatch" id="mainsail-swatch"></span>
                        <span class="color-value" id="mainsail-color-value"></span>
                    </div>

                    <!-- Fluidd color option (populated by JS if detected) -->
                    <div class="color-option-row" id="fluidd-option" style="display: none;" data-color-type="fluidd">
                        <span class="color-option-label">Fluidd</span>
                        <span class="color-swatch" id="fluidd-swatch"></span>
                        <span class="color-value" id="fluidd-color-value"></span>
                    </div>

                    <!-- Default color option -->
                    <div class="color-option-row" data-color-type="default" data-color="#4A9EFF">
                        <span class="color-option-label">Default</span>
                        <span class="color-swatch" style="background-color: #4A9EFF;"></span>
                        <span class="color-value">#4A9EFF</span>
                    </div>
                </div>
            </div>

            <div id="appearance-status"></div>

            <button type="submit" class="btn btn-primary">Save Appearance</button>
        </form>
    </div>

    <div class="settings-card">
        <h3>System Information</h3>

        <dl class="info-list">
            <dt>Platform</dt>
            <dd>{{ platform_info.platform }} ({{ platform_info.machine }})</dd>

            {% if platform_info.model %}
            <dt>Model</dt>
            <dd>{{ platform_info.model }}</dd>
            {% endif %}

            <dt>Python Version</dt>
            <dd>{{ platform_info.python_version }}</dd>

            <dt>CPU Capability Rating</dt>
            <dd>
                <span class="rating-bar">
                    <span class="rating-fill" style="width: {{ cpu_rating * 10 }}%"></span>
                </span>
                {{ cpu_rating }}/10
            </dd>
        </dl>
    </div>

    <div class="settings-card">
        <h3>Available Encoders</h3>

        <ul class="encoder-list">
            <li class="{% if encoders.software %}available{% else %}unavailable{% endif %}">
                <span class="encoder-name">Software (libx264)</span>
                <span class="encoder-status">
                    {% if encoders.software %}Available{% else %}Not available{% endif %}
                </span>
            </li>
            <li class="{% if encoders.vaapi %}available{% else %}unavailable{% endif %}">
                <span class="encoder-name">VAAPI (Intel/AMD GPU)</span>
                <span class="encoder-status">
                    {% if encoders.vaapi %}Available{% else %}Not available{% endif %}
                </span>
            </li>
            <li class="{% if encoders.rkmpp %}available{% else %}unavailable{% endif %}">
                <span class="encoder-name">RKMPP (Rockchip)</span>
                <span class="encoder-status">
                    {% if encoders.rkmpp %}Available{% else %}Not available{% endif %}
                </span>
            </li>
            <li class="{% if encoders.v4l2m2m %}available{% else %}unavailable{% endif %}">
                <span class="encoder-name">V4L2M2M (Raspberry Pi)</span>
                <span class="encoder-status">
                    {% if encoders.v4l2m2m %}Available{% else %}Not available{% endif %}
                </span>
            </li>
        </ul>

        <form method="POST"
              action="{{ url_for('cameras.redetect_encoders') }}"
              hx-post="{{ url_for('cameras.redetect_encoders') }}"
              hx-target="#encoder-status"
              hx-swap="innerHTML"
              style="margin-top: 1rem;">
            <div id="encoder-status"></div>
            <button type="submit" class="btn btn-secondary btn-sm">Re-detect Encoders</button>
            <p class="form-help" style="margin-top: 0.5rem;">Use after installing GPU drivers or hardware changes.</p>
        </form>
    </div>

    <div class="settings-card">
        <h3>About</h3>
        <p>Ravens Perch - Zero-touch camera management for Klipper</p>
        <p class="text-muted">
            Cameras are automatically detected, configured, and registered with Moonraker.
        </p>
        <p>
            <a href="https://github.com/USER/ravens-perch" target="_blank">GitHub Repository</a>
        </p>
        <p class="text-muted" style="margin-top: 1rem;">
            The footer displays lines from Edgar Allan Poe's "The Raven" (1845).
        </p>
        <button type="button" class="btn btn-secondary btn-sm" onclick="resetPoem()">
            Restart Poem
        </button>
        <span id="poem-reset-status"></span>
    </div>

    <div class="settings-card danger-zone">
        <h3>Danger Zone</h3>
        <p class="text-muted">
            Remove all camera configurations and re-detect connected cameras.
            This will reset all camera settings to defaults.
        </p>
        <form action="{{ url_for('cameras.start_fresh') }}" method="POST"
              onsubmit="return confirm('Are you sure? This will delete all camera settings and re-detect cameras.');">
            <button type="submit" class="btn btn-danger">Start Fresh</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const currentAccentColor = '{{ settings.get("accent_color", "#4A9EFF")|upper }}';
const currentCustomColor = '{{ settings.get("custom_accent_color", "#4A9EFF")|upper }}';
const DEFAULT_COLOR = '#4A9EFF';

// Apply color preview immediately by updating CSS custom properties
function applyColorPreview(hexColor) {
    const root = document.documentElement;
    root.style.setProperty('--accent-primary', hexColor);
    root.style.setProperty('--accent-hover', darkenColor(hexColor, 0.15));
    root.style.setProperty('--accent-text', getContrastColor(hexColor));
}

function darkenColor(hexColor, factor) {
    const hex = hexColor.replace('#', '');
    let r = parseInt(hex.substr(0, 2), 16);
    let g = parseInt(hex.substr(2, 2), 16);
    let b = parseInt(hex.substr(4, 2), 16);
    r = Math.round(r * (1 - factor));
    g = Math.round(g * (1 - factor));
    b = Math.round(b * (1 - factor));
    return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('').toUpperCase();
}

function getContrastColor(hexColor) {
    const hex = hexColor.replace('#', '');
    const r = parseInt(hex.substr(0, 2), 16);
    const g = parseInt(hex.substr(2, 2), 16);
    const b = parseInt(hex.substr(4, 2), 16);
    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
    return luminance > 0.5 ? '#000000' : '#FFFFFF';
}

// Update custom color when picker changes (updates both hidden inputs)
document.getElementById('custom_color_picker').addEventListener('input', function(e) {
    const color = e.target.value.toUpperCase();
    document.getElementById('accent_color').value = color;
    document.getElementById('custom_accent_color').value = color;
    document.getElementById('custom-color-value').textContent = color;
    updateActiveRow('custom');
    applyColorPreview(color);
});

// Handle clicking on color option rows
document.querySelectorAll('.color-option-row').forEach(row => {
    row.addEventListener('click', function(e) {
        // Don't trigger if clicking directly on the color picker
        if (e.target.type === 'color') return;

        const colorType = this.dataset.colorType;
        if (colorType === 'custom') {
            // For custom, trigger the color picker
            document.getElementById('custom_color_picker').click();
        } else {
            // For preset colors, only update accent_color (not custom)
            let color;
            if (colorType === 'default') {
                color = DEFAULT_COLOR;
            } else if (colorType === 'mainsail' || colorType === 'fluidd') {
                color = this.dataset.color.toUpperCase();
            }
            if (color) {
                document.getElementById('accent_color').value = color;
                updateActiveRow(colorType);
                applyColorPreview(color);
            }
        }
    });
});

function updateActiveRow(activeType) {
    document.querySelectorAll('.color-option-row').forEach(row => {
        row.classList.remove('color-option-row-active');
    });
    const activeRow = document.querySelector(`.color-option-row[data-color-type="${activeType}"]`);
    if (activeRow) {
        activeRow.classList.add('color-option-row-active');
    }
}

function detectThemeColors() {
    fetch('{{ url_for("cameras.api_detect_theme") }}')
        .then(r => r.json())
        .then(data => {
            let mainsailColor = null;
            let fluiddColor = null;

            if (data.mainsail) {
                mainsailColor = data.mainsail.toUpperCase();
                const row = document.getElementById('mainsail-option');
                row.style.display = 'flex';
                row.dataset.color = mainsailColor;
                document.getElementById('mainsail-swatch').style.backgroundColor = mainsailColor;
                document.getElementById('mainsail-color-value').textContent = mainsailColor;
            }

            if (data.fluidd) {
                fluiddColor = data.fluidd.toUpperCase();
                const row = document.getElementById('fluidd-option');
                row.style.display = 'flex';
                row.dataset.color = fluiddColor;
                document.getElementById('fluidd-swatch').style.backgroundColor = fluiddColor;
                document.getElementById('fluidd-color-value').textContent = fluiddColor;
            }

            // Determine which row should be active on load
            if (currentAccentColor === DEFAULT_COLOR) {
                updateActiveRow('default');
            } else if (mainsailColor && currentAccentColor === mainsailColor) {
                updateActiveRow('mainsail');
            } else if (fluiddColor && currentAccentColor === fluiddColor) {
                updateActiveRow('fluidd');
            } else {
                updateActiveRow('custom');
            }
        })
        .catch(err => {
            console.error('Failed to detect theme colors:', err);
            // Still set active row for custom/default
            if (currentAccentColor === DEFAULT_COLOR) {
                updateActiveRow('default');
            } else {
                updateActiveRow('custom');
            }
        });
}

// Auto-detect theme colors on page load
document.addEventListener('DOMContentLoaded', detectThemeColors);

// Reset poem to beginning
function resetPoem() {
    fetch('{{ url_for("cameras.api_reset_poem") }}', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            const status = document.getElementById('poem-reset-status');
            if (data.success) {
                status.textContent = 'Poem restarted!';
                status.style.color = 'var(--accent-primary)';
                setTimeout(() => { status.textContent = ''; }, 3000);
            }
        })
        .catch(err => {
            const status = document.getElementById('poem-reset-status');
            status.textContent = 'Failed to reset';
            status.style.color = 'var(--error)';
        });
}
</script>
{% endblock %}
