{% extends "base.html" %}

{% block title %}Settings - Ravens Perch{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Settings</h1>
</div>

<div class="settings-layout">
    <div class="settings-card">
        <h3>General Settings</h3>

        <form method="POST"
              action="{{ url_for('cameras.update_global_settings') }}"
              hx-post="{{ url_for('cameras.update_global_settings') }}"
              hx-swap="innerHTML"
              hx-target="#settings-status">

            <div class="form-group">
                <label for="moonraker_url">Moonraker URL</label>
                <input type="text"
                       id="moonraker_url"
                       name="moonraker_url"
                       value="{{ settings.get('moonraker_url', 'http://127.0.0.1:7125') }}"
                       placeholder="http://127.0.0.1:7125">
                <p class="form-help">
                    Status:
                    {% if moonraker_available %}
                        <span class="status-text status-ok">Connected</span>
                    {% else %}
                        <span class="status-text status-error">Not connected</span>
                    {% endif %}
                </p>
            </div>

            <div class="form-group">
                <label for="log_level">Log Level</label>
                <select id="log_level" name="log_level">
                    {% for level in ['DEBUG', 'INFO', 'WARNING', 'ERROR'] %}
                        <option value="{{ level }}"
                                {% if settings.get('log_level', 'INFO') == level %}selected{% endif %}>
                            {{ level }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div id="settings-status"></div>

            <button type="submit" class="btn btn-primary">Save Settings</button>
        </form>
    </div>

    <div class="settings-card">
        <h3>Appearance</h3>

        <form method="POST"
              action="{{ url_for('cameras.update_global_settings') }}"
              hx-post="{{ url_for('cameras.update_global_settings') }}"
              hx-swap="innerHTML"
              hx-target="#appearance-status">

            <div class="form-group">
                <label>Quick Select</label>
                <div id="detected-colors" class="detected-colors">
                    <span class="text-muted">Detecting Mainsail/Fluidd themes...</span>
                </div>
            </div>

            <div class="form-group">
                <label for="accent_color">Custom Color</label>
                <div class="color-picker-row">
                    <input type="color"
                           id="accent_color"
                           name="accent_color"
                           value="{{ settings.get('accent_color', '#4a9eff') }}"
                           class="color-input">
                    <span class="color-value" id="color-value">{{ settings.get('accent_color', '#4a9eff') }}</span>
                </div>
                <p class="form-help">
                    Choose a custom accent color or select from detected themes above.
                </p>
            </div>

            <div id="appearance-status"></div>

            <button type="submit" class="btn btn-primary">Save Appearance</button>
        </form>
    </div>

    <div class="settings-card">
        <h3>System Information</h3>

        <dl class="info-list">
            <dt>Platform</dt>
            <dd>{{ platform_info.platform }} ({{ platform_info.machine }})</dd>

            {% if platform_info.model %}
            <dt>Model</dt>
            <dd>{{ platform_info.model }}</dd>
            {% endif %}

            <dt>Python Version</dt>
            <dd>{{ platform_info.python_version }}</dd>

            <dt>CPU Capability Rating</dt>
            <dd>
                <span class="rating-bar">
                    <span class="rating-fill" style="width: {{ cpu_rating * 10 }}%"></span>
                </span>
                {{ cpu_rating }}/10
            </dd>
        </dl>
    </div>

    <div class="settings-card">
        <h3>Available Encoders</h3>

        <ul class="encoder-list">
            <li class="{% if encoders.software %}available{% else %}unavailable{% endif %}">
                <span class="encoder-name">Software (libx264)</span>
                <span class="encoder-status">
                    {% if encoders.software %}Available{% else %}Not available{% endif %}
                </span>
            </li>
            <li class="{% if encoders.vaapi %}available{% else %}unavailable{% endif %}">
                <span class="encoder-name">VAAPI (Intel/AMD GPU)</span>
                <span class="encoder-status">
                    {% if encoders.vaapi %}Available{% else %}Not available{% endif %}
                </span>
            </li>
            <li class="{% if encoders.rkmpp %}available{% else %}unavailable{% endif %}">
                <span class="encoder-name">RKMPP (Rockchip)</span>
                <span class="encoder-status">
                    {% if encoders.rkmpp %}Available{% else %}Not available{% endif %}
                </span>
            </li>
            <li class="{% if encoders.v4l2m2m %}available{% else %}unavailable{% endif %}">
                <span class="encoder-name">V4L2M2M (Raspberry Pi)</span>
                <span class="encoder-status">
                    {% if encoders.v4l2m2m %}Available{% else %}Not available{% endif %}
                </span>
            </li>
        </ul>

        <form method="POST"
              action="{{ url_for('cameras.redetect_encoders') }}"
              hx-post="{{ url_for('cameras.redetect_encoders') }}"
              hx-target="#encoder-status"
              hx-swap="innerHTML"
              style="margin-top: 1rem;">
            <div id="encoder-status"></div>
            <button type="submit" class="btn btn-secondary btn-sm">Re-detect Encoders</button>
            <p class="form-help" style="margin-top: 0.5rem;">Use after installing GPU drivers or hardware changes.</p>
        </form>
    </div>

    <div class="settings-card">
        <h3>About</h3>
        <p>Ravens Perch - Zero-touch camera management for Klipper</p>
        <p class="text-muted">
            Cameras are automatically detected, configured, and registered with Moonraker.
        </p>
        <p>
            <a href="https://github.com/USER/ravens-perch" target="_blank">GitHub Repository</a>
        </p>
    </div>

    <div class="settings-card danger-zone">
        <h3>Danger Zone</h3>
        <p class="text-muted">
            Remove all camera configurations and re-detect connected cameras.
            This will reset all camera settings to defaults.
        </p>
        <form action="{{ url_for('cameras.start_fresh') }}" method="POST"
              onsubmit="return confirm('Are you sure? This will delete all camera settings and re-detect cameras.');">
            <button type="submit" class="btn btn-danger">Start Fresh</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Update displayed color value when picker changes
document.getElementById('accent_color').addEventListener('input', function(e) {
    document.getElementById('color-value').textContent = e.target.value;
});

function detectThemeColors() {
    const container = document.getElementById('detected-colors');
    const currentColor = '{{ settings.get("accent_color", "#4a9eff") }}';

    fetch('{{ url_for("cameras.api_detect_theme") }}')
        .then(r => r.json())
        .then(data => {
            container.innerHTML = '';

            // Add default color option
            const defaultBtn = document.createElement('button');
            defaultBtn.type = 'button';
            defaultBtn.className = 'btn btn-sm color-option';
            defaultBtn.style.backgroundColor = '#4a9eff';
            defaultBtn.style.color = '#ffffff';
            defaultBtn.textContent = 'Default';
            if (currentColor === '#4a9eff') defaultBtn.classList.add('color-option-active');
            defaultBtn.onclick = function() { setAccentColor('#4a9eff'); };
            container.appendChild(defaultBtn);

            if (data.mainsail) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-sm color-option';
                btn.style.backgroundColor = data.mainsail;
                btn.style.color = getContrastColor(data.mainsail);
                btn.textContent = 'Mainsail';
                if (currentColor.toLowerCase() === data.mainsail.toLowerCase()) btn.classList.add('color-option-active');
                btn.onclick = function() { setAccentColor(data.mainsail); };
                container.appendChild(btn);
            }

            if (data.fluidd) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn btn-sm color-option';
                btn.style.backgroundColor = data.fluidd;
                btn.style.color = getContrastColor(data.fluidd);
                btn.textContent = 'Fluidd';
                if (currentColor.toLowerCase() === data.fluidd.toLowerCase()) btn.classList.add('color-option-active');
                btn.onclick = function() { setAccentColor(data.fluidd); };
                container.appendChild(btn);
            }

            if (!data.mainsail && !data.fluidd) {
                const note = document.createElement('span');
                note.className = 'text-muted';
                note.style.marginLeft = '0.5rem';
                note.textContent = '(No Mainsail/Fluidd themes detected)';
                container.appendChild(note);
            }
        })
        .catch(err => {
            container.innerHTML = '<span class="text-muted">Failed to detect theme colors.</span>';
        });
}

function setAccentColor(color) {
    document.getElementById('accent_color').value = color;
    document.getElementById('color-value').textContent = color;

    // Update active state on buttons
    document.querySelectorAll('.color-option').forEach(btn => {
        btn.classList.remove('color-option-active');
        if (btn.style.backgroundColor === color ||
            rgbToHex(btn.style.backgroundColor).toLowerCase() === color.toLowerCase()) {
            btn.classList.add('color-option-active');
        }
    });
}

function getContrastColor(hexColor) {
    const hex = hexColor.replace('#', '');
    const r = parseInt(hex.substr(0, 2), 16);
    const g = parseInt(hex.substr(2, 2), 16);
    const b = parseInt(hex.substr(4, 2), 16);
    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
    return luminance > 0.5 ? '#000000' : '#ffffff';
}

function rgbToHex(rgb) {
    if (rgb.startsWith('#')) return rgb;
    const match = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
    if (!match) return rgb;
    return '#' + [match[1], match[2], match[3]].map(x => {
        const hex = parseInt(x).toString(16);
        return hex.length === 1 ? '0' + hex : hex;
    }).join('');
}

// Auto-detect theme colors on page load
document.addEventListener('DOMContentLoaded', detectThemeColors);
</script>
{% endblock %}
