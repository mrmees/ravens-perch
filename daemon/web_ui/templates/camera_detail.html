{% extends "base.html" %}

{% block title %}{{ camera.friendly_name }} - Ravens Perch{% endblock %}

{% block content %}
<div class="page-header">
    <a href="{{ url_for('cameras.dashboard') }}" class="back-link">&larr; Back to Cameras</a>
    <h1 id="camera-name">{{ camera.friendly_name }}</h1>
    <div class="header-status">
        {% if camera.connected %}
            {% if camera.stream_active %}
                <span class="status-badge status-active">Live</span>
            {% else %}
                <span class="status-badge status-starting">Starting</span>
            {% endif %}
        {% else %}
            <span class="status-badge status-offline">Offline</span>
        {% endif %}
    </div>
</div>

<div class="detail-layout">
    <div class="preview-section">
        <div class="preview-container">
            {% if camera.connected and camera.stream_active %}
                <iframe src="{{ camera.stream_urls.webrtc }}"
                        class="preview-iframe"
                        allow="autoplay"
                        allowfullscreen></iframe>
            {% else %}
                <img src="{{ url_for('cameras.snapshot', camera_id=camera.id) }}"
                     alt="{{ camera.friendly_name }}"
                     class="preview-image"
                     id="preview-image">
                <div class="preview-overlay">
                    {% if not camera.connected %}
                        <span>Camera Disconnected</span>
                    {% else %}
                        <span>Stream Starting...</span>
                    {% endif %}
                </div>
            {% endif %}
        </div>
        <div class="preview-actions">
            {% if camera.connected %}
                <button class="btn btn-secondary"
                        hx-post="{{ url_for('cameras.restart_camera_stream', camera_id=camera.id) }}"
                        hx-swap="none">
                    Restart Stream
                </button>
            {% endif %}
            <a href="{{ camera.stream_urls.webrtc }}" target="_blank" class="btn btn-secondary">
                Open in New Tab
            </a>
        </div>
    </div>

    <div class="settings-section">
        <details class="settings-card" open>
            <summary>Camera Settings</summary>

            <form method="POST"
                  action="{{ url_for('cameras.update_settings', camera_id=camera.id) }}"
                  hx-post="{{ url_for('cameras.update_settings', camera_id=camera.id) }}"
                  hx-swap="innerHTML"
                  hx-target="#settings-status">

                <!-- Name -->
                <div class="form-group">
                    <label for="friendly_name">Name</label>
                    <div class="input-group">
                        <input type="text"
                               id="friendly_name"
                               name="friendly_name"
                               value="{{ camera.friendly_name }}"
                               hx-post="{{ url_for('cameras.rename_camera', camera_id=camera.id) }}"
                               hx-trigger="blur changed"
                               hx-swap="innerHTML"
                               hx-target="#camera-name">
                    </div>
                </div>

                <!-- Resolution -->
                <div class="form-group">
                    <label for="resolution">Resolution</label>
                    <select id="resolution" name="resolution"
                            hx-get="{{ url_for('cameras.api_framerates', camera_id=camera.id) }}"
                            hx-trigger="change"
                            hx-target="#framerate"
                            hx-include="[name='format'], #framerate">
                        {% for res in resolutions %}
                            <option value="{{ res }}"
                                    {% if camera.settings and camera.settings.resolution == res %}selected{% endif %}>
                                {{ res }}
                            </option>
                        {% endfor %}
                    </select>
                    <p class="form-help selection-warning" id="resolution-warning" style="display: none;">
                        Previous resolution not available for this format. Please verify your selection.
                    </p>
                </div>

                <!-- Framerate -->
                <div class="form-group">
                    <label for="framerate">Framerate</label>
                    <select id="framerate" name="framerate">
                        {% for fps in framerates %}
                            <option value="{{ fps }}"
                                    {% if camera.settings and camera.settings.framerate == fps %}selected{% endif %}>
                                {{ fps }} fps
                            </option>
                        {% endfor %}
                    </select>
                    <p class="form-help selection-warning" id="framerate-warning" style="display: none;">
                        Previous framerate not available. Please verify your selection.
                    </p>
                </div>

                <!-- Enable/Disable -->
                <div class="form-group">
                    <label class="toggle-label">
                        <span>Enable Camera</span>
                        <div class="toggle-switch"
                             hx-post="{{ url_for('cameras.toggle_enable', camera_id=camera.id) }}"
                             hx-swap="outerHTML">
                            <input type="checkbox"
                                   {% if camera.enabled %}checked{% endif %}
                                   disabled>
                            <span class="toggle-slider"></span>
                        </div>
                    </label>
                </div>

                <div id="settings-status"></div>

                <button type="submit" class="btn btn-primary btn-block">
                    Save Settings
                </button>
            </form>
        </details>

        <!-- Advanced Settings (collapsed by default) -->
        <details class="settings-card advanced-settings">
            <summary>Advanced Settings</summary>

            <form method="POST"
                  action="{{ url_for('cameras.update_settings', camera_id=camera.id) }}"
                  hx-post="{{ url_for('cameras.update_settings', camera_id=camera.id) }}"
                  hx-swap="innerHTML"
                  hx-target="#advanced-settings-status">

                <!-- Format -->
                <div class="form-group">
                    <label for="format">Input Format</label>
                    <select id="format" name="format"
                            hx-get="{{ url_for('cameras.api_resolutions', camera_id=camera.id) }}"
                            hx-trigger="change"
                            hx-target="#resolution"
                            hx-include="#resolution, #framerate">
                        {% for fmt in capabilities.keys() %}
                            <option value="{{ fmt }}"
                                    {% if camera.settings and camera.settings.format == fmt %}selected{% endif %}>
                                {{ fmt|upper }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Encoder -->
                <div class="form-group">
                    <label for="encoder">Encoder</label>
                    <select id="encoder" name="encoder" onchange="updateEncoderWarning(this)">
                        <option value="libx264"
                                {% if camera.settings and camera.settings.encoder == 'libx264' %}selected{% endif %}>
                            Software (libx264)
                        </option>
                        {% if encoders.vaapi %}
                        <option value="h264_vaapi"
                                {% if camera.settings and camera.settings.encoder == 'h264_vaapi' %}selected{% endif %}>
                            VAAPI (Intel/AMD GPU)
                        </option>
                        {% endif %}
                        {% if encoders.rkmpp %}
                        <option value="h264_rkmpp"
                                {% if camera.settings and camera.settings.encoder == 'h264_rkmpp' %}selected{% endif %}>
                            RKMPP (Rockchip) - Experimental
                        </option>
                        {% endif %}
                        {% if encoders.v4l2m2m %}
                        <option value="h264_v4l2m2m"
                                {% if camera.settings and camera.settings.encoder == 'h264_v4l2m2m' %}selected{% endif %}>
                            V4L2M2M (Raspberry Pi)
                        </option>
                        {% endif %}
                    </select>
                    <p class="form-help encoder-warning" id="rkmpp-warning" style="display: none; color: var(--warning);">
                        Warning: Rockchip RKMPP encoding has limited support and may not work reliably.
                        If you experience issues, switch to Software (libx264).
                    </p>
                </div>

                <!-- Bitrate -->
                <div class="form-group">
                    <label for="bitrate">Bitrate</label>
                    <select id="bitrate" name="bitrate">
                        {% for br in ['1M', '2M', '4M', '6M', '8M', '10M'] %}
                            <option value="{{ br }}"
                                    {% if camera.settings and camera.settings.bitrate == br %}selected{% endif %}>
                                {{ br }}bps
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Rotation -->
                <div class="form-group">
                    <label for="rotation">Rotation</label>
                    <select id="rotation" name="rotation">
                        <option value="0" {% if camera.settings and camera.settings.rotation == 0 %}selected{% endif %}>None</option>
                        <option value="90" {% if camera.settings and camera.settings.rotation == 90 %}selected{% endif %}>90&deg;</option>
                        <option value="180" {% if camera.settings and camera.settings.rotation == 180 %}selected{% endif %}>180&deg;</option>
                        <option value="270" {% if camera.settings and camera.settings.rotation == 270 %}selected{% endif %}>270&deg;</option>
                    </select>
                </div>

                <div id="advanced-settings-status"></div>

                <button type="submit" class="btn btn-primary btn-block">
                    Save Advanced Settings
                </button>
            </form>
        </details>

        <!-- Print Integration -->
        <details class="settings-card">
            <summary>Print Integration</summary>
            <p class="form-help" style="margin-bottom: 1rem;">
                Display print progress on the video feed and automatically adjust framerate during prints.
                Requires Moonraker connection.
            </p>

            <form method="POST"
                  action="{{ url_for('cameras.update_settings', camera_id=camera.id) }}"
                  hx-post="{{ url_for('cameras.update_settings', camera_id=camera.id) }}"
                  hx-swap="innerHTML"
                  hx-target="#print-settings-status">

                <!-- Overlay Toggle -->
                <div class="form-group">
                    <label class="toggle-label">
                        <span>Show Print Status Overlay</span>
                        <label class="toggle-switch">
                            <input type="checkbox"
                                   name="overlay_enabled"
                                   value="1"
                                   {% if camera.settings and camera.settings.overlay_enabled %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </label>
                </div>

                <h4 style="margin: 1.5rem 0 0.75rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">Overlay Appearance</h4>

                <!-- Overlay Font -->
                <div class="form-group">
                    <label for="overlay_font">Font</label>
                    <div id="font-select-container"
                         hx-get="{{ url_for('cameras.api_fonts') }}?current={{ camera.settings.overlay_font|default('', true)|urlencode }}"
                         hx-trigger="load"
                         hx-target="this"
                         hx-swap="innerHTML">
                        <select id="overlay_font" name="overlay_font">
                            <option value="">Loading fonts...</option>
                        </select>
                    </div>
                </div>

                <!-- Overlay Font Size -->
                <div class="form-group">
                    <label for="overlay_font_size">Text Size</label>
                    <select id="overlay_font_size" name="overlay_font_size">
                        {% for size in [16, 20, 24, 28, 32, 36, 48, 64] %}
                            <option value="{{ size }}"
                                    {% if camera.settings and camera.settings.overlay_font_size == size %}selected{% endif %}
                                    {% if not camera.settings and size == 24 %}selected{% endif %}>
                                {{ size }}px{% if size == 24 %} (default){% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Overlay Position -->
                <div class="form-group">
                    <label for="overlay_position">Position</label>
                    <select id="overlay_position" name="overlay_position">
                        {% set positions = [
                            ('top_left', 'Top Left'),
                            ('top_center', 'Top Center'),
                            ('top_right', 'Top Right'),
                            ('bottom_left', 'Bottom Left'),
                            ('bottom_center', 'Bottom Center'),
                            ('bottom_right', 'Bottom Right')
                        ] %}
                        {% for value, label in positions %}
                            <option value="{{ value }}"
                                    {% if camera.settings and camera.settings.overlay_position == value %}selected{% endif %}
                                    {% if not camera.settings and value == 'bottom_center' %}selected{% endif %}>
                                {{ label }}{% if value == 'bottom_center' %} (default){% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Overlay Color -->
                <div class="form-group">
                    <label for="overlay_color">Color</label>
                    <select id="overlay_color" name="overlay_color">
                        {% set colors = [
                            ('white', 'White'),
                            ('yellow', 'Yellow'),
                            ('cyan', 'Cyan'),
                            ('green', 'Green'),
                            ('red', 'Red'),
                            ('orange', 'Orange')
                        ] %}
                        {% for value, label in colors %}
                            <option value="{{ value }}"
                                    {% if camera.settings and camera.settings.overlay_color == value %}selected{% endif %}
                                    {% if not camera.settings and value == 'white' %}selected{% endif %}>
                                {{ label }}{% if value == 'white' %} (default){% endif %}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Format Options -->
                <div class="form-group">
                    <label class="toggle-label">
                        <span>Multi-line Layout</span>
                        <label class="toggle-switch">
                            <input type="checkbox"
                                   name="overlay_multiline"
                                   value="1"
                                   {% if camera.settings and camera.settings.overlay_multiline %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </label>
                    <p class="form-help">Stack stats vertically instead of on one line.</p>
                </div>

                <div class="form-group">
                    <label class="toggle-label">
                        <span>Show Labels</span>
                        <label class="toggle-switch">
                            <input type="checkbox"
                                   name="overlay_show_labels"
                                   value="1"
                                   {% if camera.settings and camera.settings.overlay_show_labels != False %}checked{% endif %}>
                            <span class="toggle-slider"></span>
                        </label>
                    </label>
                    <p class="form-help">Show labels like "Progress:" before values.</p>
                </div>

                <h4 style="margin: 1.5rem 0 0.75rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">Stats to Display</h4>

                <div class="checkbox-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
                    <!-- Progress -->
                    <label class="checkbox-label">
                        <input type="checkbox" name="overlay_show_progress" value="1"
                               {% if camera.settings and camera.settings.overlay_show_progress != False %}checked{% endif %}>
                        <span>Progress %</span>
                    </label>

                    <!-- Layer -->
                    <label class="checkbox-label">
                        <input type="checkbox" name="overlay_show_layer" value="1"
                               {% if camera.settings and camera.settings.overlay_show_layer != False %}checked{% endif %}>
                        <span>Layer</span>
                    </label>

                    <!-- ETA -->
                    <label class="checkbox-label">
                        <input type="checkbox" name="overlay_show_eta" value="1"
                               {% if camera.settings and camera.settings.overlay_show_eta != False %}checked{% endif %}>
                        <span>ETA</span>
                    </label>

                    <!-- Elapsed -->
                    <label class="checkbox-label">
                        <input type="checkbox" name="overlay_show_elapsed" value="1"
                               {% if camera.settings and camera.settings.overlay_show_elapsed %}checked{% endif %}>
                        <span>Elapsed Time</span>
                    </label>

                    <!-- Filename -->
                    <label class="checkbox-label">
                        <input type="checkbox" name="overlay_show_filename" value="1"
                               {% if camera.settings and camera.settings.overlay_show_filename %}checked{% endif %}>
                        <span>Filename</span>
                    </label>

                    <!-- Print State -->
                    <label class="checkbox-label">
                        <input type="checkbox" name="overlay_show_print_state" value="1"
                               {% if camera.settings and camera.settings.overlay_show_print_state %}checked{% endif %}>
                        <span>Print State</span>
                    </label>

                    <!-- Hotend Temp -->
                    <label class="checkbox-label">
                        <input type="checkbox" name="overlay_show_hotend_temp" value="1"
                               {% if camera.settings and camera.settings.overlay_show_hotend_temp %}checked{% endif %}>
                        <span>Hotend Temp</span>
                    </label>

                    <!-- Bed Temp -->
                    <label class="checkbox-label">
                        <input type="checkbox" name="overlay_show_bed_temp" value="1"
                               {% if camera.settings and camera.settings.overlay_show_bed_temp %}checked{% endif %}>
                        <span>Bed Temp</span>
                    </label>

                    <!-- Fan Speed -->
                    <label class="checkbox-label">
                        <input type="checkbox" name="overlay_show_fan_speed" value="1"
                               {% if camera.settings and camera.settings.overlay_show_fan_speed %}checked{% endif %}>
                        <span>Fan Speed</span>
                    </label>

                    <!-- Print Speed -->
                    <label class="checkbox-label">
                        <input type="checkbox" name="overlay_show_print_speed" value="1"
                               {% if camera.settings and camera.settings.overlay_show_print_speed %}checked{% endif %}>
                        <span>Print Speed</span>
                    </label>

                    <!-- Z Height -->
                    <label class="checkbox-label">
                        <input type="checkbox" name="overlay_show_z_height" value="1"
                               {% if camera.settings and camera.settings.overlay_show_z_height %}checked{% endif %}>
                        <span>Z Height</span>
                    </label>

                    <!-- Filament Used -->
                    <label class="checkbox-label">
                        <input type="checkbox" name="overlay_show_filament_used" value="1"
                               {% if camera.settings and camera.settings.overlay_show_filament_used %}checked{% endif %}>
                        <span>Filament Used</span>
                    </label>

                    <!-- Current Time -->
                    <label class="checkbox-label">
                        <input type="checkbox" name="overlay_show_current_time" value="1"
                               {% if camera.settings and camera.settings.overlay_show_current_time %}checked{% endif %}>
                        <span>Current Time</span>
                    </label>

                    <!-- Live Velocity -->
                    <label class="checkbox-label">
                        <input type="checkbox" name="overlay_show_live_velocity" value="1"
                               {% if camera.settings and camera.settings.overlay_show_live_velocity %}checked{% endif %}>
                        <span>Head Speed</span>
                    </label>

                    <!-- Flow Rate -->
                    <label class="checkbox-label">
                        <input type="checkbox" name="overlay_show_flow_rate" value="1"
                               {% if camera.settings and camera.settings.overlay_show_flow_rate %}checked{% endif %}>
                        <span>Flow Rate</span>
                    </label>

                    <!-- Filament Type -->
                    <label class="checkbox-label">
                        <input type="checkbox" name="overlay_show_filament_type" value="1"
                               {% if camera.settings and camera.settings.overlay_show_filament_type %}checked{% endif %}>
                        <span>Filament Type</span>
                    </label>
                </div>

                <h4 style="margin: 1.5rem 0 0.75rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">Update Settings</h4>

                <!-- Overlay Update Interval -->
                <div class="form-group">
                    <label for="overlay_update_interval">Overlay Update Interval</label>
                    <input type="range"
                           id="overlay_update_interval"
                           name="overlay_update_interval"
                           min="1"
                           max="10"
                           value="{{ settings.get('overlay_update_interval', 5) }}"
                           oninput="document.getElementById('overlay_interval_value').textContent = this.value + 's'">
                    <span id="overlay_interval_value" class="range-value">{{ settings.get('overlay_update_interval', 5) }}s</span>
                    <p class="form-help">How often to update the overlay text (1-10 seconds). Affects all cameras.</p>
                </div>

                <h4 style="margin: 1.5rem 0 0.75rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">Dynamic Framerate</h4>

                <!-- Printing Framerate -->
                <div class="form-group">
                    <label for="printing_framerate">Printing Framerate</label>
                    <select id="printing_framerate" name="printing_framerate">
                        <option value="">Use default</option>
                        {% for fps in [5, 10, 15, 20, 24, 30, 60] %}
                            <option value="{{ fps }}"
                                    {% if camera.settings and camera.settings.printing_framerate == fps %}selected{% endif %}>
                                {{ fps }} fps
                            </option>
                        {% endfor %}
                    </select>
                    <p class="form-help">Framerate to use while actively printing.</p>
                </div>

                <!-- Standby Framerate -->
                <div class="form-group">
                    <label for="standby_framerate">Standby Framerate</label>
                    <select id="standby_framerate" name="standby_framerate">
                        <option value="">Use default</option>
                        {% for fps in [1, 2, 5, 10, 15] %}
                            <option value="{{ fps }}"
                                    {% if camera.settings and camera.settings.standby_framerate == fps %}selected{% endif %}>
                                {{ fps }} fps
                            </option>
                        {% endfor %}
                    </select>
                    <p class="form-help">Lower framerate when not printing to save bandwidth and CPU.</p>
                </div>

                <div id="print-settings-status"></div>

                <button type="submit" class="btn btn-primary btn-block">
                    Save Print Settings
                </button>
            </form>
        </details>

        <!-- Camera Controls (V4L2) -->
        {% if camera.connected %}
        <details class="settings-card advanced-settings">
            <summary>Camera Controls</summary>
            <p class="form-help" style="margin-bottom: 1rem;">
                Adjust brightness, contrast, exposure, and other camera-specific settings.
                Changes are applied immediately and saved for stream restarts.
            </p>
            <div id="v4l2-controls"
                 hx-get="{{ url_for('cameras.api_get_controls', camera_id=camera.id) }}"
                 hx-trigger="load"
                 hx-swap="innerHTML">
                <div class="loading-controls">Loading camera controls...</div>
            </div>
        </details>
        {% endif %}

        <!-- Stream URLs -->
        <details class="settings-card">
            <summary>Stream URLs</summary>
            <div class="url-list">
                <div class="url-item">
                    <label>WebRTC</label>
                    <code>{{ camera.stream_urls.webrtc }}</code>
                </div>
                <div class="url-item">
                    <label>RTSP</label>
                    <code>{{ camera.stream_urls.rtsp }}</code>
                </div>
                <div class="url-item">
                    <label>Snapshot</label>
                    <code>{{ camera.stream_urls.snapshot }}</code>
                </div>
            </div>
        </details>

        <!-- FFmpeg Command -->
        {% if ffmpeg_cmd %}
        <details class="settings-card">
            <summary>FFmpeg Command</summary>
            <div class="ffmpeg-command">
                <code>{{ ffmpeg_cmd }}</code>
            </div>
        </details>
        {% endif %}

        <!-- Device Info -->
        <details class="settings-card">
            <summary>Device Information</summary>
            <dl class="info-list">
                <dt>Hardware Name</dt>
                <dd>{{ camera.hardware_name }}</dd>
                {% if camera.serial_number %}
                <dt>Serial Number</dt>
                <dd>{{ camera.serial_number }}</dd>
                {% endif %}
                <dt>Device Path</dt>
                <dd>{{ camera.device_path or 'Not connected' }}</dd>
                <dt>First Seen</dt>
                <dd>{{ camera.first_seen }}</dd>
                <dt>Last Seen</dt>
                <dd>{{ camera.last_seen }}</dd>
            </dl>
        </details>

        <!-- Danger Zone -->
        <details class="settings-card danger-zone">
            <summary>Danger Zone</summary>
            <p class="danger-text">These actions cannot be undone.</p>

            <div class="danger-actions">
                <form action="{{ url_for('cameras.delete_camera', camera_id=camera.id) }}"
                      method="POST"
                      onsubmit="return confirm('Are you sure you want to delete this camera? This cannot be undone.');">
                    <button type="submit" class="btn btn-danger">
                        Delete Camera
                    </button>
                    <span class="action-help">Remove camera from database. It will be re-added if reconnected.</span>
                </form>

                <form action="{{ url_for('cameras.ignore_camera_route', camera_id=camera.id) }}"
                      method="POST"
                      onsubmit="return confirm('Are you sure you want to ignore this camera? It will never be detected again until removed from the ignore list.');">
                    <button type="submit" class="btn btn-danger">
                        Ignore Camera
                    </button>
                    <span class="action-help">Delete and add to ignore list. Camera will not be auto-detected again.</span>
                </form>
            </div>
        </details>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Refresh snapshot preview if not using WebRTC
    const previewImage = document.getElementById('preview-image');
    if (previewImage) {
        setInterval(() => {
            const src = previewImage.src.split('?')[0];
            previewImage.src = src + '?t=' + Date.now();
        }, 2000);
    }

    // Show/hide RKMPP warning based on encoder selection
    function updateEncoderWarning(select) {
        const warning = document.getElementById('rkmpp-warning');
        if (warning) {
            warning.style.display = select.value === 'h264_rkmpp' ? 'block' : 'none';
        }
    }

    // Handle selection changed warnings
    function showSelectionWarning(elementId) {
        const warning = document.getElementById(elementId + '-warning');
        const select = document.getElementById(elementId);

        if (warning && select) {
            // First, expand the parent details element if collapsed
            const parentDetails = select.closest('details');
            if (parentDetails && !parentDetails.open) {
                parentDetails.open = true;
            }

            // Show warning and highlight
            warning.style.display = 'block';
            select.classList.add('selection-changed');

            // Scroll the select into view
            select.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Remove highlight after 3 seconds
            setTimeout(() => select.classList.remove('selection-changed'), 3000);

            // Auto-hide warning after 5 seconds
            setTimeout(() => {
                warning.style.display = 'none';
            }, 5000);
        }
    }

    // Listen for HTMX events to detect selection changes
    document.body.addEventListener('htmx:afterRequest', function(event) {
        const trigger = event.detail.xhr.getResponseHeader('HX-Trigger');
        if (trigger === 'selectionChanged') {
            const targetId = event.detail.target.id;
            showSelectionWarning(targetId);
        }
    });

    // When resolution dropdown is updated, also trigger framerate update
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'resolution') {
            // Trigger change event to cascade to framerate
            const resolution = document.getElementById('resolution');
            if (resolution) {
                htmx.trigger(resolution, 'change');
            }
        }
    });

    // Check initial encoder selection on page load
    document.addEventListener('DOMContentLoaded', function() {
        const encoderSelect = document.getElementById('encoder');
        if (encoderSelect) {
            updateEncoderWarning(encoderSelect);
        }
    });

</script>

<style>
    /* Checkbox grid styling */
    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.2s;
    }
    .checkbox-label:hover {
        background-color: rgba(255, 255, 255, 0.05);
    }
    .checkbox-label input[type="checkbox"] {
        width: 1.1rem;
        height: 1.1rem;
        cursor: pointer;
    }
    .checkbox-label span {
        font-size: 0.9rem;
    }
    .checkbox-grid {
        background: rgba(0, 0, 0, 0.1);
        padding: 0.5rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}
