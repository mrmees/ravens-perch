<div class="v4l2-controls-grid">
    {% for name, info in controls.items() %}
    <div class="control-item-compact" data-control="{{ name }}">
        <div class="control-header-compact">
            <label for="ctrl-{{ name }}">{{ name.replace('_', ' ').title() }}</label>
            {% if info.type == 'menu' and info.options %}
            <button type="button" class="btn-reset-ctrl"
                    hx-post="{{ url_for('cameras.api_reset_control', camera_id=camera_id, control_name=name) }}"
                    hx-swap="none"
                    onclick="document.getElementById('ctrl-{{ name }}').value = '{{ info.default }}'; document.getElementById('v4l2-{{ name }}').value = '{{ info.default }}';"
                    title="Reset to default ({{ info.options.get(info.default, info.default) }})">
                Reset
            </button>
            {% elif info.type == 'bool' %}
            <button type="button" class="btn-reset-ctrl"
                    hx-post="{{ url_for('cameras.api_reset_control', camera_id=camera_id, control_name=name) }}"
                    hx-swap="none"
                    onclick="var cb = document.getElementById('ctrl-{{ name }}'); cb.checked = {{ 'true' if info.default == 1 else 'false' }}; document.getElementById('v4l2-{{ name }}').value = cb.checked ? '1' : '0';"
                    title="Reset to default ({{ 'On' if info.default == 1 else 'Off' }})">
                Reset
            </button>
            {% else %}
            <button type="button" class="btn-reset-ctrl"
                    hx-post="{{ url_for('cameras.api_reset_control', camera_id=camera_id, control_name=name) }}"
                    hx-swap="none"
                    onclick="document.getElementById('ctrl-{{ name }}').value = {{ info.default }}; document.getElementById('val-{{ name }}').textContent = {{ info.default }}; document.getElementById('v4l2-{{ name }}').value = {{ info.default }};"
                    title="Reset to default ({{ info.default }})">
                Reset
            </button>
            {% endif %}
        </div>

        {% if info.type == 'menu' and info.options %}
        <!-- Menu control -->
        <input type="hidden" name="v4l2_{{ name }}" id="v4l2-{{ name }}" value="{{ info.value }}">
        <select id="ctrl-{{ name }}"
                class="control-select-compact"
                hx-post="{{ url_for('cameras.api_preview_control', camera_id=camera_id, control_name=name) }}"
                hx-trigger="change"
                hx-swap="none"
                hx-vals='js:{value: event.target.value}'
                onchange="document.getElementById('v4l2-{{ name }}').value = this.value;">
            {% for opt_value, opt_label in info.options.items()|sort %}
            <option value="{{ opt_value }}" {% if info.value == opt_value %}selected{% endif %}>
                {{ opt_label }}
            </option>
            {% endfor %}
        </select>

        {% elif info.type == 'bool' %}
        <!-- Boolean control -->
        <div class="control-bool-compact">
            <input type="hidden" name="v4l2_{{ name }}" id="v4l2-{{ name }}" value="{{ info.value }}">
            <label class="toggle-switch-sm">
                <input type="checkbox"
                       id="ctrl-{{ name }}"
                       {% if info.value == 1 %}checked{% endif %}
                       hx-post="{{ url_for('cameras.api_preview_control', camera_id=camera_id, control_name=name) }}"
                       hx-trigger="change"
                       hx-swap="none"
                       hx-vals='js:{value: event.target.checked ? "1" : "0"}'
                       onchange="document.getElementById('v4l2-{{ name }}').value = this.checked ? '1' : '0';">
                <span class="toggle-slider-sm"></span>
            </label>
        </div>

        {% else %}
        <!-- Integer control (slider) -->
        <div class="control-slider-compact">
            <input type="hidden" name="v4l2_{{ name }}" id="v4l2-{{ name }}" value="{{ info.value }}">
            <input type="range"
                   id="ctrl-{{ name }}"
                   min="{{ info.min }}"
                   max="{{ info.max }}"
                   step="{{ info.step|default(1) }}"
                   value="{{ info.value }}"
                   class="control-range-compact"
                   oninput="document.getElementById('val-{{ name }}').textContent = this.value; document.getElementById('v4l2-{{ name }}').value = this.value;"
                   hx-post="{{ url_for('cameras.api_preview_control', camera_id=camera_id, control_name=name) }}"
                   hx-trigger="change"
                   hx-swap="none"
                   hx-vals='js:{value: event.target.value}'>
            <span id="val-{{ name }}" class="control-val">{{ info.value }}</span>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>

<style>
    .v4l2-controls-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem 1.5rem;
    }
    .control-item-compact {
        min-width: 0;
    }
    .control-header-compact {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.35rem;
        gap: 0.5rem;
    }
    .control-header-compact label {
        font-size: 0.8rem;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
    }
    .btn-reset-ctrl {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        color: var(--text-muted);
        cursor: pointer;
        padding: 0.15rem 0.4rem;
        font-size: 0.7rem;
        border-radius: var(--radius-sm);
        white-space: nowrap;
        transition: color 0.2s, border-color 0.2s;
    }
    .btn-reset-ctrl:hover {
        color: var(--accent-primary);
        border-color: var(--accent-primary);
    }
    .control-select-compact {
        width: 100%;
        padding: 0.35rem 0.5rem;
        font-size: 0.8rem;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-sm);
        color: var(--text-primary);
    }
    .control-slider-compact {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .control-range-compact {
        flex: 1;
        height: 4px;
        -webkit-appearance: none;
        appearance: none;
        background: var(--bg-tertiary);
        border-radius: 2px;
    }
    .control-range-compact::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: var(--accent-primary);
        cursor: pointer;
    }
    .control-range-compact::-moz-range-thumb {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: var(--accent-primary);
        cursor: pointer;
        border: none;
    }
    .control-val {
        min-width: 2.5rem;
        text-align: right;
        font-size: 0.75rem;
        color: var(--text-muted);
        font-family: monospace;
    }
    .control-bool-compact {
        display: flex;
        align-items: center;
    }
    .toggle-switch-sm {
        position: relative;
        display: inline-block;
        width: 36px;
        height: 20px;
    }
    .toggle-switch-sm input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .toggle-slider-sm {
        position: absolute;
        cursor: pointer;
        inset: 0;
        background-color: var(--bg-tertiary);
        border-radius: 20px;
        transition: 0.2s;
    }
    .toggle-slider-sm:before {
        position: absolute;
        content: "";
        height: 14px;
        width: 14px;
        left: 3px;
        bottom: 3px;
        background-color: var(--text-muted);
        border-radius: 50%;
        transition: 0.2s;
    }
    .toggle-switch-sm input:checked + .toggle-slider-sm {
        background-color: var(--accent-primary);
    }
    .toggle-switch-sm input:checked + .toggle-slider-sm:before {
        transform: translateX(16px);
        background-color: white;
    }
    @media (max-width: 500px) {
        .v4l2-controls-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
